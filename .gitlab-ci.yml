image: docker:latest

services:
  - docker:dind

before_script:
  - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN $CONTAINER_REGISTRY
  - apk --no-cache add make

stages:
  - configure
  - build
  - test
  - release

configure:
  stage: configure
  script:
    - sh configure init -r $CONTAINER_REGISTRY -n $CI_PROJECT_NAMESPACE -p $CI_PROJECT_NAME
    - sh configure metadata -c $CI_BUILD_REF
  artifacts:
    paths:
      - "*.variable"
    expire_in: 2 hours
  only:
    - /^scheme-.*$/

build:
  stage: build
  script:
    - make all && make push
  dependencies:
    - configure
  artifacts:
    paths:
      - "*.variable"
    expire_in: 2 hours
  only:
    - /^scheme-.*$/

test:
  stage: test
  script:
    - make get
    - make test
  dependencies:
    - build
  artifacts:
    paths:
      - "*.variable"
      - test/*
    expire_in: 2 hours
  only:
    - /^scheme-.*$/

release:
  stage: release
  script:
    - docker login -u $DOCKER_BUILD_USER -p $DOCKER_BUILD_TOKEN
    - make pull
    - make deploy
  dependencies:
    - test
  only:
    - /^scheme-.*$/